# CI for GitHub Actions Library
# Validates all workflows and composite actions

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint-workflows:
    name: Lint Workflows
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: actionlint
        uses: reviewdog/action-actionlint@4f8f9963ca57a41e5571f27a1296a11f32e6fceb # v1.43.0
        with:
          github_token: ${{ github.token }}
          reporter: github-pr-review
          fail_on_error: true

  validate-actions:
    name: Validate Composite Actions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Validate action.yml files
        run: |
          echo "Validating composite action definitions..."
          for action in composite-actions/*/action.yml; do
            echo "Checking $action..."
            # Basic YAML validation
            python3 -c "import yaml; yaml.safe_load(open('$action'))" || exit 1
            echo "✓ $action is valid YAML"
          done

      - name: Check for SHA-pinned actions
        run: |
          echo "Checking for SHA-pinned action references..."
          
          # Find all workflow and action files
          files=$(find . -name "*.yml" -o -name "*.yaml" | grep -E '(workflows|composite-actions)')
          
          violations=0
          for file in $files; do
            # Check for unpinned actions (uses: owner/action@v1 instead of @sha)
            if grep -E "uses:\s+[^@]+@v[0-9]" "$file" 2>/dev/null; then
              echo "⚠️ Found version-tagged action in $file (should use SHA)"
              violations=$((violations + 1))
            fi
          done
          
          if [ $violations -gt 0 ]; then
            echo "::warning::Found $violations action(s) using version tags instead of SHA pins"
          else
            echo "✓ All actions are properly SHA-pinned"
          fi

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Check README
        run: |
          if [ ! -f README.md ]; then
            echo "::error::README.md is missing"
            exit 1
          fi
          
          # Check README has key sections
          for section in "Quick Start" "Repository Structure" "Security"; do
            if ! grep -q "$section" README.md; then
              echo "::warning::README.md should have a '$section' section"
            fi
          done
          
          echo "✓ README.md exists and has required sections"

      - name: Validate links
        uses: gaurav-nelson/github-action-markdown-link-check@5c5dfc0ac2e225883c0e5f03a85311ec2830d368 # v1.0.15
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc_config.json'
        continue-on-error: true
